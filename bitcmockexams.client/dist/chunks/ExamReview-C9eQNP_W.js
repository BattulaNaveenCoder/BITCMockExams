import{r as o,j as e}from"./react-vendor-DKmEC8F-.js";import{u as fe}from"./tests-DgJ3-0M2.js";import{c as ge,a as be,g as je,B as ae}from"../assets/index-D77BABSw.js";import{S as p}from"./Skeleton-CRRsf-47.js";import{p as re,G as H,c as J,q as we,x as ye,y as ve,I as Ne,J as Ie}from"./icons-sFf4zKND.js";import{d as Se}from"./crypto-sz_6m3EK.js";import{d as Te,u as Me,a as Pe}from"./router-D05wPq9Z.js";import"./jwt-VWaDGczM.js";import"./http-client-B9ygI19o.js";const ee=({html:i,className:m})=>e.jsx("div",{className:m,dangerouslySetInnerHTML:{__html:i}}),R=({icon:i,value:m,label:x,tone:c="default"})=>{const d={success:"text-green-600",error:"text-red-600",warning:"text-amber-600",default:"text-primary-blue"};return e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-200 p-5 flex items-center gap-4",children:[e.jsx("div",{className:`w-10 h-10 grid place-items-center rounded-full bg-light-blue ${d[c]}`,children:i}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-extrabold tracking-tight",children:m}),e.jsx("div",{className:"text-xs font-semibold text-text-secondary uppercase mt-1",children:x})]})]})},ke=({percent:i,required:m,result:x})=>{const c=Math.max(0,Math.min(100,i||0)),d=Math.max(0,Math.min(100,m||0)),j=x==="PASSED";return e.jsx("div",{className:"rounded-2xl overflow-hidden shadow-sm bg-gradient-to-r from-primary-blue to-secondary-blue text-white",children:e.jsxs("div",{className:"px-6 py-6 md:px-8 md:py-8",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-white/90 font-semibold",children:"Overall Performance"}),e.jsxs("div",{className:"text-xs opacity-90",children:["Required: ",d,"% to pass"]})]}),e.jsx(Ie,{className:"opacity-90"})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-4",children:[e.jsxs("div",{className:"text-5xl font-extrabold tracking-tight",children:[Number(c).toFixed(1),"%"]}),e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-white/10 text-white border border-white/20",children:[j?e.jsx(H,{}):e.jsx(J,{}),j?"Congratulations! You Passed!":"Commiserations! Try Again!"]})]}),e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"relative h-3 rounded-full bg-white/30",children:[e.jsx("div",{className:"absolute left-0 top-0 h-3 rounded-full bg-white/70",style:{width:`${c}%`}}),e.jsx("div",{className:"absolute -top-1 h-5 w-[2px] bg-white/90",style:{left:`${d}%`}})]}),e.jsxs("div",{className:"mt-2 flex justify-between text-xs",children:[e.jsx("span",{children:"0%"}),e.jsxs("span",{children:["Required: ",d,"%"]}),e.jsx("span",{children:"100%"})]})]})]})})},Ce=({state:i,children:m})=>{const x={correct:"bg-green-50 border-green-200 text-green-800","chosen-correct":"bg-green-100 border-green-300 text-green-800","chosen-incorrect":"bg-red-100 border-red-300 text-red-800",neutral:"bg-white border-gray-200 text-text-primary"},c=i==="correct"||i==="chosen-correct"?e.jsx(H,{className:"text-green-600"}):i==="chosen-incorrect"?e.jsx(J,{className:"text-red-500"}):null;return e.jsxs("div",{className:`flex items-center gap-3 p-4 border rounded-lg transition-colors ${x[i]}`,children:[e.jsx("div",{className:"flex-1",children:m}),c]})},Fe=({active:i,duration:m=4e3})=>{const x=o.useRef(null);return o.useEffect(()=>{if(!i)return;const c=x.current;if(!c)return;const d=c.getContext("2d");if(!d)return;let j=0,u=!0;const f=Math.max(1,Math.floor(window.devicePixelRatio||1)),z=()=>{const C=window.innerWidth,y=window.innerHeight;c.width=C*f,c.height=y*f,c.style.width=C+"px",c.style.height=y+"px",d.setTransform(f,0,0,f,0,0)};z();const l=()=>z();window.addEventListener("resize",l);const E=["#0078D4","#50E6FF","#1E90FF","#00B7C3","#7DD3FC","#93C5FD"],I=[],A=(C,y,g)=>{for(let a=0;a<g;a++){const S=Math.random()*Math.PI*2,K=6+Math.random()*4;I.push({x:C,y,vx:Math.cos(S)*K,vy:Math.sin(S)*K-3,size:6+Math.random()*6,color:E[Math.floor(Math.random()*E.length)],rotation:Math.random()*Math.PI,rotationSpeed:(Math.random()-.5)*.2,shape:Math.random()<.6?"rect":"circle",life:0})}},P=window.innerWidth,D=window.innerHeight;A(P*.25,D*.25,80),A(P*.75,D*.25,80);const te=setTimeout(()=>A(P*.5,D*.2,120),300),O=.15,k=.003,$=.002,L=m,B=performance.now(),w=C=>{if(!u)return;const y=C-B;d.clearRect(0,0,c.width/f,c.height/f);for(let g=I.length-1;g>=0;g--){const a=I[g];if(a.life+=16,a.vy+=O,a.vx*=1-k,a.vy*=1-k,a.x+=a.vx,a.y+=a.vy,a.rotation+=a.rotationSpeed,a.y-a.size>window.innerHeight+20||a.life>L+1e3){I.splice(g,1);continue}const S=Math.max(0,1-y*$/m);d.globalAlpha=S,d.fillStyle=a.color,d.save(),d.translate(a.x,a.y),d.rotate(a.rotation),a.shape==="rect"?d.fillRect(-a.size/2,-a.size/2,a.size,a.size*.6):(d.beginPath(),d.arc(0,0,a.size/2,0,Math.PI*2),d.fill()),d.restore(),d.globalAlpha=1}j=requestAnimationFrame(w)};j=requestAnimationFrame(w);const W=setTimeout(()=>{u=!1,cancelAnimationFrame(j)},m+800);return()=>{u=!1,cancelAnimationFrame(j),clearTimeout(W),clearTimeout(te),window.removeEventListener("resize",l)}},[i,m]),i?e.jsx("div",{className:"fixed inset-0 pointer-events-none z-50",children:e.jsx("canvas",{ref:x})}):null},Ee=i=>String.fromCharCode(65+i),Ae=i=>{if(i.status)return i.status;if(!i.selectedOptionIds?.length)return"unanswered";const m=new Set(i.options.filter(c=>c.isCorrect).map(c=>c.id)),x=new Set(i.selectedOptionIds);if(m.size!==x.size)return"incorrect";for(const c of x)if(!m.has(c))return"incorrect";return"correct"},Ue=()=>{const{buyerTestId:i}=Te(),{getBuyerTestById:m,getAllExamQuestionsById:x,getAllOptionsWithQuestionId:c}=fe(),{globalSearch:d,getTestSuiteByPathId:j}=ge(),u=Me(),[f,z]=o.useState(null),[l,E]=o.useState(null),[I,A]=o.useState(null),[P,D]=o.useState({}),[te,O]=o.useState(!1),[k,$]=o.useState({}),{user:L}=be(),B=o.useMemo(()=>je(L),[L]);o.useEffect(()=>{let t=!0;return(async()=>{if(!i)return;const s=await m(i,!1);if(!(!t||!s)){z(s);try{const r=s?.JsonAsString?JSON.parse(s.JsonAsString):null;E(r)}catch(r){console.error("Failed to parse JsonAsString for buyer test:",r),E(null)}}})(),()=>{t=!1}},[i,m]),o.useEffect(()=>{let t=!0;return(async()=>{const s=l?.FKTestId||l?.TestId||l?.FKTestID;if(!s)return;O(!0);const r=await x(s,!1);t&&(A(r),O(!1))})(),()=>{t=!1}},[l,x]);const w=!l||I===null,W=l?.Title||"Exam Review";f?.FkTestID,l&&(t=>{if(!t||t<=0)return"—";const n=Math.floor(t/60),s=t%60;return`${String(n).padStart(2,"0")}:${String(s).padStart(2,"0")}`})(l.DurationinSeconds);const y=l?.PassPercentage,g=l?.TotalMarksAllocated??0,a=l?.Questions?.reduce((t,n)=>t+(n?.MarksScoredForthisQuestion||0),0)??0,S=g>0?a/g*100:0,K=Math.round(S);w||g===0||S.toFixed(1);const ie=typeof y=="number"&&g>0,_=!w&&ie?K>=y?"PASSED":"FAILED":null,[oe,G]=o.useState(!1);o.useEffect(()=>{if(!w&&_==="PASSED"){G(!0);const t=setTimeout(()=>G(!1),5e3);return()=>clearTimeout(t)}else w||G(!1)},[_,w]);const V=o.useMemo(()=>{if(!I||!l?.Questions)return null;const t=new Map;return l.Questions.forEach(n=>t.set(n.QuestionId,n)),I.map((n,s)=>{const r=t.get(n.PKTestQuestionId),v=typeof r?.SelectedOptionId=="string"?r.SelectedOptionId.split(",").map(b=>b.trim()).filter(Boolean):[],N=Number(r?.MarksScoredForthisQuestion||0)>0?"correct":v.length===0?"unanswered":"incorrect";return{id:n.PKTestQuestionId,index:n.SerialNumber??s+1,text:n.Description||"",options:P[n.PKTestQuestionId]||[],selectedOptionIds:v,explanation:n.Explanation||void 0,status:N}})},[I,l,P]),F=V??[],le=F.length;console.log("ExamReview rendered with data:",{buyerTestId:i,buyerTest:f,vm:l,questions:F});const se=Pe(),[T,ce]=o.useState(null);o.useEffect(()=>{const n=new URLSearchParams(se.search).get("suite");console.log("ExamReview query parsed. Has suite token?",!!n),n&&(async()=>{console.log("Decrypting suite token...");const s=await Se(n);console.log("Decrypted suite meta:",s),s&&typeof s=="object"&&ce(s)})()},[se.search]);const M=o.useCallback(async()=>{const t=T?.PathId||null;if(t&&typeof t=="string"&&t.trim())return t.trim();const n=l?.PathId||f?.PathId||null;if(n&&typeof n=="string"&&n.trim())return n.trim();const v=(l?.Title||f?.Title||"").match(/\b([A-Z]{2,3}-\d{2,3})\b/)?.[1];if(!v)return null;try{return(await d(v,0,5))?.find(b=>(b?.PathId||"").toUpperCase().startsWith(v.toUpperCase()))?.PathId||null}catch{return null}},[T,l,f,d]),de=o.useCallback(async()=>{if(typeof window<"u"&&window.history.length>1){u(-1);return}const t=T?.PathId||await M();u(t?`/exams/${t}`:"/mock-exams")},[u,T,M]),[Y,Q]=o.useState(null),[ne,me]=o.useState(null);o.useEffect(()=>{let t=!0;return(async()=>{try{const s=l?.FKTestId||l?.TestId||l?.FKTestID||null;if(!s){t&&Q(null);return}const r=T?.PathId||await M();if(!r){t&&Q(null);return}t&&me(r);const h=(await j(r,B))?.TestsDetailsDTO||[],N=h.findIndex(b=>(b?.PKTestId||b?.TestId)===s);if(N>=0&&N+1<h.length){const b=h[N+1],U=encodeURIComponent(b?.Title||"Next"),q=`/exams/${r}/${U}/${b?.PKTestId||b?.TestId}`;t&&Q(q)}else t&&Q(null)}catch{t&&Q(null)}})(),()=>{t=!1}},[l,T,M,j,B]);const xe=o.useCallback(async()=>{if(Y){u(Y);return}const t=ne||await M();u(t?`/exams/${t}`:"/mock-exams")},[Y,u,ne,M]);o.useEffect(()=>{const t=async()=>{try{const n=T?.PathId||await M();console.log("Browser back intercepted. Navigating to topics:",n),u(n?`/exams/${n}`:"/mock-exams",{replace:!0})}catch{u("/mock-exams",{replace:!0})}};return window.addEventListener("popstate",t),()=>window.removeEventListener("popstate",t)},[T,M,u]);const[ue,he]=o.useState(new Set),pe=async t=>{if(he(n=>n.has(t)?new Set:new Set([t])),!P[t]&&!k[t]){$(s=>({...s,[t]:!0}));const n=await c(t,!1);if(n&&Array.isArray(n)){const s=n.map(r=>({id:r.PKOptionId,text:r.Description||"",isCorrect:!!r.IsCorrect}));D(r=>({...r,[t]:s}))}$(s=>({...s,[t]:!1}))}},Z=o.useMemo(()=>F.map(t=>Ae(t)),[F]),X=o.useMemo(()=>{let t=0,n=0,s=0;return Z.forEach(r=>{r==="correct"?t++:r==="incorrect"?n++:s++}),{correct:t,incorrect:n,unanswered:s,total:F.length}},[Z,F.length]);return e.jsxs("div",{className:"min-h-screen bg-bg-light",children:[e.jsx("div",{className:"bg-gradient-to-r from-primary-blue to-secondary-blue text-white",children:e.jsxs("div",{className:"w-full px-4 sm:px-6 py-6 flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-extrabold tracking-tight",children:W}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ae,{variant:"secondary",size:"medium",onClick:de,children:"Retake Exam"}),e.jsx(ae,{variant:"primary",size:"medium",onClick:xe,disabled:!1,children:"Next Topic"})]})]})}),e.jsx("div",{className:"w-full px-4 sm:px-6 py-6 grid grid-cols-12 gap-6",children:e.jsxs("div",{className:"col-span-12 flex flex-col gap-6",children:[w?e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4",children:Array.from({length:5}).map((t,n)=>e.jsxs("div",{className:"rounded-2xl border border-gray-200 p-5",children:[e.jsx(p,{className:"h-6 w-6 rounded-full mb-3"}),e.jsx(p,{className:"h-8 w-24 mb-2"}),e.jsx(p,{className:"h-4 w-28"})]},n))}):e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4",children:[e.jsx(Fe,{active:oe,duration:4200}),e.jsx(R,{icon:e.jsx(re,{}),value:X.total,label:"Total Questions",tone:"default"}),e.jsx(R,{icon:e.jsx(re,{}),value:g,label:"Total Marks",tone:"default"}),e.jsx(R,{icon:e.jsx(H,{}),value:a,label:"Marks Scored",tone:"success"}),e.jsx(R,{icon:e.jsx(J,{}),value:X.incorrect,label:"Incorrect",tone:"error"}),e.jsx(R,{icon:e.jsx(we,{}),value:X.unanswered,label:"Unanswered",tone:"warning"})]}),w?e.jsx("div",{className:"rounded-2xl overflow-hidden shadow-sm bg-slate-200",children:e.jsxs("div",{className:"px-6 py-6 md:px-8 md:py-8",children:[e.jsx(p,{className:"h-4 w-40 mb-3"}),e.jsx(p,{className:"h-10 w-32 mb-3"}),e.jsx(p,{className:"h-4 w-64"})]})}):e.jsx(ke,{percent:S,required:y??0,result:_}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-100 font-bold text-text-primary",children:"Questions"}),e.jsx("ul",{className:"divide-y divide-gray-100",children:(V===null?Array.from({length:5}):F).map((t,n)=>{const s=V===null?null:t;if(!s)return e.jsx("li",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx(p,{className:"w-8 h-8 rounded-full"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(p,{className:"h-4 w-48"}),e.jsx(p,{className:"h-5 w-24 rounded-full"})]}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsx(p,{className:"h-3 w-full"}),e.jsx(p,{className:"h-3 w-11/12"})]})]})]})},`skeleton-${n}`);const r=ue.has(s.id),v=Z[n];return e.jsx("li",{className:"group",children:e.jsxs("div",{className:"px-6 py-4 flex items-start gap-4 cursor-pointer hover:bg-gray-50",role:"button","aria-expanded":r,onClick:()=>pe(s.id),children:[e.jsx("div",{className:"mt-1",children:e.jsx("span",{className:"inline-flex items-center justify-center w-8 h-8 rounded-full border border-gray-300 text-gray-700 bg-white",children:r?e.jsx(ye,{}):e.jsx(ve,{})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"font-semibold text-text-primary truncate",children:["Question ",s.index," of ",le]}),v==="correct"?e.jsxs("span",{className:"inline-flex items-center gap-2 text-green-700 bg-green-50 px-3 py-1 rounded-full text-xs font-semibold",children:[e.jsx(H,{})," Correct"]}):v==="incorrect"?e.jsxs("span",{className:"inline-flex items-center gap-2 text-red-600 bg-red-50 px-3 py-1 rounded-full text-xs font-semibold",children:[e.jsx(J,{})," Incorrect"]}):e.jsx("span",{className:"inline-flex items-center gap-2 text-slate-700 bg-slate-50 px-3 py-1 rounded-full text-xs font-semibold",children:"Unanswered"})]}),e.jsx("div",{className:"mt-2 text-[15px] leading-relaxed text-text-primary",children:s.text&&s.text.trim()?/<[a-z][\s\S]*>/i.test(s.text)?e.jsx(ee,{html:s.text,className:"prose max-w-none"}):e.jsx("p",{className:"line-clamp-3",children:s.text}):e.jsx("span",{className:"text-sm text-slate-500",children:"This question’s content isn’t included in the saved results."})}),r&&e.jsxs("div",{className:"mt-4 space-y-4 animate-fadeIn",children:[e.jsxs("div",{className:"space-y-3",children:[k[s.id]&&(!s.options||s.options.length===0)&&e.jsx(e.Fragment,{children:Array.from({length:3}).map((h,N)=>e.jsx("div",{className:"p-4 border rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(p,{className:"w-7 h-7 rounded-md"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(p,{className:"h-3 w-3/4"}),e.jsx(p,{className:"h-3 w-2/3"})]})]})},`opt-skel-${N}`))}),!k[s.id]&&s.options&&s.options.length>0&&s.options.map((h,N)=>{const b=Ee(N),U=s.selectedOptionIds?.includes(h.id),q=h.isCorrect&&U?"chosen-correct":h.isCorrect?"correct":U?"chosen-incorrect":"neutral";return e.jsx(Ce,{state:q,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"mt-0.5 inline-flex items-center justify-center w-7 h-7 rounded-md bg-light-blue text-primary-blue font-bold",children:b}),/<[a-z][\s\S]*>/i.test(h.text)?e.jsx(ee,{html:h.text,className:"prose max-w-none text-[15px] leading-relaxed"}):e.jsx("span",{className:"text-[15px] leading-relaxed",children:h.text})]})},h.id)}),!k[s.id]&&(!s.options||s.options.length===0)&&e.jsx("div",{className:"text-sm text-slate-500 bg-slate-50 border border-slate-200 rounded-lg p-4",children:"No options are available in these results."})]}),s.explanation&&e.jsxs("div",{className:"rounded-xl border border-amber-200 bg-amber-50 p-5 text-amber-900",children:[e.jsxs("div",{className:"flex items-center gap-2 font-semibold mb-2",children:[e.jsx(Ne,{})," Explanation"]}),/<[a-z][\s\S]*>/i.test(s.explanation)?e.jsx(ee,{html:s.explanation,className:"prose max-w-none text-[15px] leading-relaxed"}):e.jsx("p",{className:"text-[15px] leading-relaxed",children:s.explanation})]})]})]})]})},s.id)})})]})]})}),e.jsx("style",{children:`
					.prose p { margin-bottom: 0.75rem; }
					.prose ul, .prose ol { margin-left: 1.25rem; margin-bottom: 0.75rem; }
					.prose li { margin-bottom: 0.35rem; }
					.prose code { background: #f3f4f6; padding: .125rem .25rem; border-radius: .25rem; }
					.prose img { max-width: 100%; height: auto; border-radius: .5rem; margin: .75rem 0; }
					.prose table { border-collapse: collapse; width: 100%; margin: .75rem 0; }
					.prose th, .prose td { border: 1px solid #e5e7eb; padding: .5rem; text-align: left; }
					.prose th { background: #f9fafb; font-weight: 600; }
				`})]})};export{Ue as default};
